import 'package:flutter/material.dart';

// --- ESTRUTURA DE DADOS ---
// A classe `Estudante` define o "molde" para os objetos que serão manipulados no aplicativo.
// Cada objeto terá um nome, idade, curso, matrícula, média do aluno e tipo.
class Estudante {
  String nome;
  int idade;
  String curso;
  double matricula;
  double mediaAluno;
  String tipo;

  // O construtor é o responsável por inicializar os atributos do objeto.
  // Os atributos marcados com `required` são obrigatórios na criação de cada estudante.
  Estudante(this.nome, this.idade, this.curso,
      {required this.matricula, required this.mediaAluno, required this.tipo});
}

// --- PONTO DE ENTRADA DO APLICATIVO ---
// A função `main` é o ponto de partida de qualquer aplicativo Flutter.
// Ela chama `runApp` para iniciar a execução do widget principal.
void main() {
  runApp(const MyApp());
}

// --- WIDGET PRINCIPAL IMUTÁVEL ---
// `MyApp` é um `StatelessWidget`, o que significa que ele não gerencia nenhum estado mutável.
// Ele serve como a raiz da árvore de widgets, definindo configurações globais como tema e página inicial.
class MyApp extends StatelessWidget {
  const MyApp({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    // O `MaterialApp` é um widget que configura o aplicativo para seguir o Material Design.
    return MaterialApp(
      title: 'Gerenciamento de Estudantes',
      theme: ThemeData(
        primarySwatch: Colors.indigo,
        visualDensity: VisualDensity.adaptivePlatformDensity,
        fontFamily: 'Inter',
      ),
      // A página inicial do aplicativo, que é o `StudentListPage`.
      home: const StudentListPage(),
    );
  }
}

// --- WIDGET PRINCIPAL DE ESTADO ---
// `StudentListPage` é um `StatefulWidget` porque a interface do usuário (UI) pode mudar
// em tempo real, dependendo da interação do usuário. Ele gerencia a lista de estudantes e os filtros.
class StudentListPage extends StatefulWidget {
  const StudentListPage({Key? key}) : super(key: key);

  @override
  // Este método cria e retorna a classe de estado associada a este widget.
  _StudentListPageState createState() => _StudentListPageState();
}

// --- CLASSE DE ESTADO ---
// Esta classe armazena todos os dados que podem mudar e a lógica que opera sobre esses dados.
class _StudentListPageState extends State<StudentListPage> {
  // Variáveis de estado que controlam o comportamento e a aparência da UI.
  bool _isDarkMode = false;
  int _sortMode = 0;

  // Lista original e imutável de estudantes.
  final List<Estudante> todosEstudantes = [
    Estudante("Ana", 25, "Engenharia", matricula: 26793, mediaAluno: 8.5, tipo: "a+"),
    Estudante("Heitor", 34, "Ciencias Politicas", matricula: 21875, mediaAluno: 8.8, tipo: "b-"),
    Estudante("Bruno", 22, "Medicina", matricula: 34567, mediaAluno: 7.8, tipo: "a+"),
    Estudante("Carla", 30, "Direito", matricula: 78045, mediaAluno: 9.3, tipo: "b+"),
    Estudante("yasmim", 27, "Direito", matricula: 94674, mediaAluno: 8.0, tipo: "b+"),
    Estudante("Daniel", 31, "Arquitetura", matricula: 45678, mediaAluno: 6.9, tipo: "ab-"),
    Estudante("Terezinha", 23, "Psicologia", matricula: 56789, mediaAluno: 8.2, tipo: "a-"),
    Estudante("Felipe", 19, "Engenharia", matricula: 67890, mediaAluno: 6.7, tipo: "b-"),
    Estudante("Gabriel", 22, "Psicologia", matricula: 78901, mediaAluno: 7.5, tipo: "o+"),
    Estudante("Helho", 24, "Medicina", matricula: 89012, mediaAluno: 9.0, tipo: "b-"),
    Estudante("Isabela", 21, "Educação Física", matricula: 10927, mediaAluno: 8.3, tipo: "a+"),
    Estudante("João", 26, "Nutricionista", matricula: 11234, mediaAluno: 6.4, tipo: "b+"),
    Estudante("Ricardo", 33, "Agronomia", matricula: 30308, mediaAluno: 9.1, tipo: "o+"),
    Estudante("Marina", 19, "Design Gráfico", matricula: 67890, mediaAluno: 7.9, tipo: "a-"),
    Estudante("Edson", 28, "Educação Física", matricula: 39460, mediaAluno: 7.9, tipo: "a+"),
  ];

  // A lista que é exibida na tela. Ela é modificada com base nos filtros e na ordenação.
  List<Estudante> estudantesFiltrados = [];
  
  // `TextEditingController`s são usados para capturar e gerenciar o texto de campos de entrada.
  final TextEditingController minIdadeController = TextEditingController();
  final TextEditingController maxIdadeController = TextEditingController();
  final TextEditingController minMediaController = TextEditingController();
  final TextEditingController maxMediaController = TextEditingController();

  // --- MÉTODOS DO CICLO DE VIDA ---
  // `initState()` é chamado quando o widget é inserido na árvore de widgets pela primeira vez.
  // É o local ideal para inicializar o estado e adicionar "listeners" para eventos externos.
  @override
  void initState() {
    super.initState();
    _aplicarFiltros();
    // Os listeners garantem que os filtros sejam aplicados automaticamente
    // sempre que o usuário digita algo nos campos de texto.
    minIdadeController.addListener(_aplicarFiltros);
    maxIdadeController.addListener(_aplicarFiltros);
    minMediaController.addListener(_aplicarFiltros);
    maxMediaController.addListener(_aplicarFiltros);
  }

  // `dispose()` é chamado quando o widget é removido da árvore de widgets.
  // É usado para liberar recursos e evitar vazamentos de memória.
  @override
  void dispose() {
    minIdadeController.dispose();
    maxIdadeController.dispose();
    minMediaController.dispose();
    maxMediaController.dispose();
    super.dispose();
  }

  // --- FUNÇÕES DE LÓGICA ---
  // Esta função aplica os filtros e a ordenação na lista de estudantes.
  void _aplicarFiltros() {
    // `setState` notifica o framework de que o estado do widget foi alterado,
    // o que força o Flutter a redesenhar a UI para refletir as mudanças.
    setState(() {
      // Cria uma cópia temporária da lista original.
      List<Estudante> tempEstudantes = todosEstudantes.toList();

      // Lógica de ordenação: a lista é ordenada com base no modo de ordenação atual.
      if (_sortMode == 1) {
        tempEstudantes.sort((a, b) => a.nome.compareTo(b.nome));
      } else if (_sortMode == 2) {
        tempEstudantes.sort((a, b) => b.idade.compareTo(a.idade));
      }
      
      // Lógica de filtragem: a lista é filtrada com base nos valores dos campos de texto.
      estudantesFiltrados = tempEstudantes.where((estudante) {
        final double? minIdade = double.tryParse(minIdadeController.text);
        final double? maxIdade = double.tryParse(maxIdadeController.text);
        final double? minMedia = double.tryParse(minMediaController.text);
        final double? maxMedia = double.tryParse(maxMediaController.text);

        final bool atendeIdade = (minIdade == null || estudante.idade >= minIdade) &&
            (maxIdade == null || estudante.idade <= maxIdade);

        final bool atendeMedia = (minMedia == null || estudante.mediaAluno >= minMedia) &&
            (maxMedia == null || estudante.mediaAluno <= maxMedia);

        return atendeIdade && atendeMedia;
      }).toList();
    });
  }

  // Esta função limpa o texto em todos os controladores, o que, por sua vez, aciona os listeners
  // e reverte o filtro.
  void _limparCampos() {
    minIdadeController.clear();
    maxIdadeController.clear();
    minMediaController.clear();
    maxMediaController.clear();
  }

  // Alterna o estado da variável que controla o modo de cores (claro/escuro).
  // A chamada a `setState` faz com que a UI seja redesenhada com as novas cores.
  void _toggleDarkMode() {
    setState(() {
      _isDarkMode = !_isDarkMode;
    });
  }

  // Alterna o modo de ordenação, percorrendo os valores de 0, 1 e 2.
  // Em seguida, chama `_aplicarFiltros` para reordenar a lista.
  void _toggleSort() {
    setState(() {
      _sortMode = (_sortMode + 1) % 3;
    });
    _aplicarFiltros();
  }

  // --- CONSTRUÇÃO DA INTERFACE (UI) ---
  // O método `build` é responsável por construir a árvore de widgets da interface do usuário.
  // É chamado sempre que o estado do widget muda.
  @override
  Widget build(BuildContext context) {
    // Variáveis que armazenam as cores com base no modo atual (`_isDarkMode`).
    final Color backgroundColor = _isDarkMode ? Colors.grey.shade900 : Colors.grey.shade200;
    final Color cardColor = _isDarkMode ? Colors.grey.shade800 : Colors.white;
    final Color textColor = _isDarkMode ? Colors.white : Colors.black87;
    final Color subtitleColor = _isDarkMode ? Colors.yellow.shade700 : Colors.black54;
    final Color accentColor = _isDarkMode ? Colors.green.shade200 : Colors.red.shade200;
    final Color iconColor = _isDarkMode ? Colors.green : Colors.red;

    // `Scaffold` é um widget que fornece uma estrutura visual básica.
    return Scaffold(
      backgroundColor: backgroundColor,
      appBar: AppBar(
        title: Text('Gerenciamento de Estudantes', style: TextStyle(color: textColor)),
        centerTitle: true,
        backgroundColor: _isDarkMode ? Colors.black : Colors.indigo,
      ),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.fromLTRB(16.0, 24.0, 16.0, 8.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Catálogo de Estudantes',
                        style: TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          color: textColor,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        'Use os campos abaixo para filtrar os resultados.',
                        style: TextStyle(
                          fontSize: 16,
                          color: subtitleColor,
                        ),
                      ),
                    ],
                  ),
                ),
                SizedBox(
                  height: 48,
                  child: Row(
                    children: [
                      ElevatedButton(
                        // `onPressed` chama a função que altera a ordenação.
                        onPressed: _toggleSort,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.indigo,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text('Ordenar', style: TextStyle(color: Colors.white)),
                      ),
                      const SizedBox(width: 8),
                      ElevatedButton(
                        // `onPressed` chama a função que limpa os campos de texto.
                        onPressed: _limparCampos,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.black,
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 15),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text(
                          'Zerar',
                          style: TextStyle(color: Colors.white),
                        ),
                      ),
                      const SizedBox(width: 8),
                      IconButton(
                        // `onPressed` chama a função que alterna o modo de cores.
                        onPressed: _toggleDarkMode,
                        icon: const Icon(Icons.wb_sunny_rounded, size: 28),
                        color: _isDarkMode ? Colors.yellow.shade700 : Colors.black,
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16.0),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    // `controller` conecta o campo de texto ao `TextEditingController`.
                    controller: minIdadeController,
                    keyboardType: TextInputType.number,
                    style: TextStyle(color: textColor),
                    decoration: InputDecoration(
                      contentPadding: const EdgeInsets.symmetric(vertical: 20.0),
                      labelText: 'Idade Mínima',
                      labelStyle: TextStyle(color: subtitleColor),
                      border: const OutlineInputBorder(
                        borderRadius: BorderRadius.all(Radius.circular(12)),
                      ),
                    ),
                  ),
                ),
                const SizedBox(width: 10),
                Expanded(
                  child: TextField(
                    controller: maxIdadeController,
                    keyboardType: TextInputType.number,
                    style: TextStyle(color: textColor),
                    decoration: InputDecoration(
                      contentPadding: const EdgeInsets.symmetric(vertical: 20.0),
                      labelText: 'Idade Máxima',
                      labelStyle: TextStyle(color: subtitleColor),
                      border: const OutlineInputBorder(
                        borderRadius: BorderRadius.all(Radius.circular(12)),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: minMediaController,
                    keyboardType: TextInputType.number,
                    style: TextStyle(color: textColor),
                    decoration: InputDecoration(
                      contentPadding: const EdgeInsets.symmetric(vertical: 20.0),
                      labelText: 'Média Mínima',
                      labelStyle: TextStyle(color: subtitleColor),
                      border: const OutlineInputBorder(
                        borderRadius: BorderRadius.all(Radius.circular(12)),
                      ),
                    ),
                  ),
                ),
                const SizedBox(width: 10),
                Expanded(
                  child: TextField(
                    controller: maxMediaController,
                    keyboardType: TextInputType.number,
                    style: TextStyle(color: textColor),
                    decoration: InputDecoration(
                      contentPadding: const EdgeInsets.symmetric(vertical: 20.0),
                      labelText: 'Média Máxima',
                      labelStyle: TextStyle(color: subtitleColor),
                      border: const OutlineInputBorder(
                        borderRadius: BorderRadius.all(Radius.circular(12)),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          // `Expanded` faz com que o `ListView` ocupe o espaço restante disponível.
          Expanded(
            // `ListView.builder` constrói a lista de forma eficiente, criando os itens
            // somente quando eles se tornam visíveis.
            child: ListView.builder(
              itemCount: estudantesFiltrados.length,
              itemBuilder: (context, index) {
                // Pega o estudante da lista filtrada.
                final estudante = estudantesFiltrados[index];
                return Card(
                  elevation: 4,
                  color: cardColor,
                  margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: ListTile(
                    contentPadding: const EdgeInsets.all(16),
                    leading: CircleAvatar(
                      backgroundColor: accentColor,
                      child: Text(
                        estudante.nome[0],
                        style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.white),
                      ),
                    ),
                    title: Text(
                      estudante.nome,
                      style: TextStyle(fontWeight: FontWeight.bold, color: textColor),
                    ),
                    subtitle: Text(
                      'Idade: ${estudante.idade} | Curso: ${estudante.curso}\nMédia: ${estudante.mediaAluno} | Tipo: ${estudante.tipo.toUpperCase()}\nMatrícula: ${estudante.matricula.toInt()}',
                      style: TextStyle(color: subtitleColor),
                    ),
                    trailing: Icon(Icons.square, color: iconColor),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}
